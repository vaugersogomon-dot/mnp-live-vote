
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LiveVote - Система живого голосования</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            margin: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        #loading-screen {
            position: fixed;
            inset: 0;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <script>
        window.process = { env: { API_KEY: '' } };
    </script>

    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.0.0",
    "react-dom": "https://esm.sh/react-dom@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.460.0",
    "recharts": "https://esm.sh/recharts@2.13.3",
    "qrcode.react": "https://esm.sh/qrcode.react@4.1.0",
    "@google/genai": "https://esm.sh/@google/genai@0.21.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="loading-screen">
        <div class="spinner"></div>
        <div style="color: #64748b; font-weight: 600; font-size: 14px;">Загрузка LiveVote...</div>
    </div>

    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Settings, Users, BarChart3, Vote, Plus, Trash2, 
            RefreshCcw, QrCode, Loader2, Download, Copy, 
            CheckCircle2, Info, AlertTriangle, Check, Star, UserCheck, TrendingUp, Trophy
        } from 'lucide-react';
        import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } from 'recharts';
        import { QRCodeSVG } from 'qrcode.react';
        import { GoogleGenAI } from "@google/genai";

        // --- Types ---
        const AppView = {
            ADMIN: 'admin',
            VOTE: 'vote',
            LEADERBOARD: 'leaderboard'
        };

        // --- Components ---

        const Navbar = ({ currentView, setView }) => (
            <nav className="bg-white border-b sticky top-0 z-50">
                <div className="container mx-auto px-4 h-16 flex items-center justify-between">
                    <div className="flex items-center gap-2 cursor-pointer" onClick={() => { window.location.hash = ''; setView(AppView.ADMIN); }}>
                        <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                            <Vote className="text-white w-5 h-5" />
                        </div>
                        <span className="font-bold text-xl tracking-tight text-slate-800">LiveVote</span>
                    </div>
                    <div className="hidden md:flex items-center gap-6">
                        <button onClick={() => { window.location.hash = ''; setView(AppView.ADMIN); }} className={`flex items-center gap-1.5 px-3 py-2 rounded-md transition-colors ${currentView === AppView.ADMIN ? 'bg-indigo-50 text-indigo-600' : 'text-slate-600 hover:bg-slate-50'}`}>
                            <Settings className="w-4 h-4" /> <span className="font-medium text-sm">Админ</span>
                        </button>
                        <button onClick={() => { window.location.hash = 'vote'; setView(AppView.VOTE); }} className={`flex items-center gap-1.5 px-3 py-2 rounded-md transition-colors ${currentView === AppView.VOTE ? 'bg-indigo-50 text-indigo-600' : 'text-slate-600 hover:bg-slate-50'}`}>
                            <Users className="w-4 h-4" /> <span className="font-medium text-sm">Голосование</span>
                        </button>
                        <button onClick={() => { window.location.hash = 'results'; setView(AppView.LEADERBOARD); }} className={`flex items-center gap-1.5 px-3 py-2 rounded-md transition-colors ${currentView === AppView.LEADERBOARD ? 'bg-indigo-50 text-indigo-600' : 'text-slate-600 hover:bg-slate-50'}`}>
                            <BarChart3 className="w-4 h-4" /> <span className="font-medium text-sm">Результаты</span>
                        </button>
                    </div>
                    <div className="md:hidden flex items-center gap-4">
                        <button onClick={() => { window.location.hash = 'vote'; setView(AppView.VOTE); }} className="p-2 text-indigo-600 bg-indigo-50 rounded-lg">
                            <Vote className="w-5 h-5" />
                        </button>
                    </div>
                </div>
            </nav>
        );

        const AdminView = ({ participants, onAdd, onDelete, onReset, sessionTitle, setSessionTitle }) => {
            const [isProcessing, setIsProcessing] = useState(false);
            const [processedCount, setProcessedCount] = useState(0);
            const [copied, setCopied] = useState(false);
            const fileInputRef = useRef(null);
            const qrRef = useRef(null);
            const customBaseUrl = window.location.origin + window.location.pathname;
            const voteUrl = `${customBaseUrl}#vote`;

            const compressImage = (file) => new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        let width = img.width, height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });

            const handleFileChange = async (e) => {
                const files = e.target.files;
                if (!files || files.length === 0) return;
                setIsProcessing(true);
                const fileArray = Array.from(files);
                for (let i = 0; i < fileArray.length; i++) {
                    const compressed = await compressImage(fileArray[i]);
                    onAdd(`Участник #${participants.length + i + 1}`, compressed);
                    setProcessedCount(i + 1);
                }
                setIsProcessing(false);
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            const downloadQR = () => {
                const svg = qrRef.current;
                if (!svg) return;
                const svgData = new XMLSerializer().serializeToString(svg);
                const canvas = document.createElement("canvas");
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width; canvas.height = img.height;
                    canvas.getContext("2d").drawImage(img, 0, 0);
                    const link = document.createElement("a");
                    link.download = "livevote-qr.png";
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                };
                img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgData)));
            };

            return (
                <div className="max-w-6xl mx-auto space-y-8 pb-20">
                    <div className="bg-white p-8 rounded-3xl border shadow-sm flex flex-col md:flex-row justify-between gap-6">
                        <div className="flex-1">
                            <h1 className="text-3xl font-black text-slate-900 mb-2">Настройка голосования</h1>
                            <input type="text" value={sessionTitle} onChange={(e) => setSessionTitle(e.target.value)} className="text-indigo-600 font-bold border-b border-dashed border-indigo-200 focus:border-indigo-500 outline-none w-full text-lg" />
                        </div>
                        <button onClick={onReset} className="flex items-center gap-2 px-5 py-2 text-red-600 hover:bg-red-50 rounded-xl transition-all border border-red-100">
                            <RefreshCcw className="w-4 h-4" /> Сброс
                        </button>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div className="lg:col-span-8 space-y-6">
                            <div onClick={() => !isProcessing && fileInputRef.current?.click()} className={`p-10 rounded-[2.5rem] border-4 border-dashed transition-all flex flex-col items-center justify-center min-h-[250px] cursor-pointer ${isProcessing ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100 hover:border-indigo-400'}`}>
                                {isProcessing ? <div className="text-center"><Loader2 className="w-12 h-12 text-indigo-600 animate-spin mx-auto mb-4" /><p className="font-bold">Загрузка {processedCount}...</p></div> : <div className="text-center"><Plus className="w-12 h-12 text-indigo-400 mx-auto mb-4" /><h3 className="text-2xl font-black">Загрузить фото</h3><p className="text-slate-400">Выберите одного или нескольких участников</p></div>}
                                <input ref={fileInputRef} type="file" multiple accept="image/*" onChange={handleFileChange} className="hidden" />
                            </div>
                            <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                {participants.map((p, idx) => (
                                    <div key={p.id} className="relative group bg-white border rounded-2xl overflow-hidden shadow-sm">
                                        <img src={p.photoUrl} className="aspect-square w-full object-cover" />
                                        <div className="absolute top-2 left-2 px-2 py-0.5 bg-black/60 rounded text-white text-[10px] font-bold">#{idx + 1}</div>
                                        <button onClick={() => onDelete(p.id)} className="absolute top-2 right-2 p-1 bg-white text-red-500 rounded-md opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 className="w-4 h-4" /></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="lg:col-span-4">
                            <div className="bg-slate-900 p-8 rounded-[2.5rem] text-white text-center space-y-6">
                                <h3 className="text-xl font-black flex items-center justify-center gap-2"><QrCode className="w-6 h-6 text-indigo-400" /> Вход для зрителей</h3>
                                <div className="bg-white p-4 rounded-3xl inline-block">
                                    <QRCodeSVG ref={qrRef} value={voteUrl} size={180} level="H" />
                                </div>
                                <button onClick={downloadQR} className="w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold flex items-center justify-center gap-2">
                                    <Download className="w-4 h-4" /> Скачать QR
                                </button>
                                <div className="text-xs text-slate-400 truncate break-all opacity-50">{voteUrl}</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const VoterView = ({ participants, onVote, hasVoted, sessionTitle }) => {
            const [selectedId, setSelectedId] = useState(null);
            if (hasVoted) return (
                <div className="max-w-md mx-auto text-center py-24 px-6">
                    <div className="w-20 h-20 bg-indigo-600 text-white rounded-[1.5rem] flex items-center justify-center mx-auto mb-8 rotate-3 shadow-xl"><UserCheck className="w-10 h-10" /></div>
                    <h2 className="text-4xl font-black mb-4">Спасибо!</h2>
                    <button onClick={() => window.location.hash = 'results'} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-lg">РЕЗУЛЬТАТЫ</button>
                </div>
            );
            return (
                <div className="max-w-4xl mx-auto px-4 pb-40">
                    <div className="text-center mb-12 mt-6"><h1 className="text-4xl font-black text-slate-900">{sessionTitle}</h1><p className="text-slate-500 font-medium">Выберите участника</p></div>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6">
                        {participants.map((p, idx) => (
                            <div key={p.id} onClick={() => setSelectedId(p.id)} className={`relative rounded-[2rem] overflow-hidden bg-white border-4 transition-all duration-300 ${selectedId === p.id ? 'border-indigo-600 scale-[1.03]' : 'border-white hover:border-slate-100'}`}>
                                <img src={p.photoUrl} className="aspect-[3/4] w-full object-cover" />
                                <div className="absolute bottom-0 inset-x-0 p-4 bg-gradient-to-t from-black/80 to-transparent flex items-end justify-between text-white">
                                    <p className="text-xl font-black">#{idx + 1}</p>
                                    {selectedId === p.id && <div className="bg-indigo-600 p-1 rounded-lg"><Check className="w-5 h-5 stroke-[4px]" /></div>}
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="fixed bottom-10 left-0 right-0 px-6"><button disabled={!selectedId} onClick={() => onVote(selectedId)} className={`max-w-sm mx-auto w-full py-5 rounded-3xl font-black text-xl shadow-2xl transition-all ${selectedId ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-400'}`}>ГОЛОСОВАТЬ</button></div>
                </div>
            );
        };

        const LeaderboardView = ({ participants, sessionTitle }) => {
            const sorted = useMemo(() => [...participants].sort((a, b) => b.votes - a.votes), [participants]);
            const totalVotes = useMemo(() => participants.reduce((acc, p) => acc + p.votes, 0), [participants]);
            const [aiInsight, setAiInsight] = useState('');

            useEffect(() => {
                if (participants.length === 0 || totalVotes === 0) return;
                const getAI = async () => {
                    try {
                        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                        const res = await ai.models.generateContent({
                            model: 'gemini-3-flash-preview',
                            contents: `Голосование "${sessionTitle}". Лидер: ${sorted[0].name}. Напиши позитивный комментарий (8 слов).`,
                        });
                        setAiInsight(res.text);
                    } catch (e) {}
                };
                getAI();
            }, [sorted[0]?.votes]);

            const chartData = participants.map(p => ({ name: p.name.substring(0, 10), votes: p.votes })).sort((a,b) => b.votes - a.votes);
            const COLORS = ['#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#f59e0b'];

            return (
                <div className="max-w-6xl mx-auto space-y-8">
                    <div className="bg-white p-10 rounded-[2.5rem] border shadow-sm flex flex-col md:flex-row items-center justify-between">
                        <div><h1 className="text-4xl font-black text-slate-900">{sessionTitle}</h1><p className="text-slate-400 font-bold uppercase tracking-widest text-xs">Прямой эфир</p></div>
                        <div className="text-center"><p className="text-5xl font-black text-indigo-600">{totalVotes}</p><p className="text-[10px] font-black text-slate-400">ГОЛОСОВ</p></div>
                    </div>
                    {aiInsight && <div className="bg-indigo-600 text-white p-6 rounded-3xl shadow-lg animate-bounce-subtle"><p className="font-bold italic">"{aiInsight}"</p></div>}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="bg-white p-8 rounded-[2rem] border shadow-sm space-y-6">
                            <h3 className="text-xl font-black flex items-center gap-2"><Trophy className="text-yellow-500" /> Топ участников</h3>
                            {sorted.slice(0, 5).map((p, i) => (
                                <div key={p.id} className="flex items-center gap-4 p-3 rounded-2xl bg-slate-50 border border-slate-100">
                                    <img src={p.photoUrl} className="w-12 h-12 rounded-xl object-cover" />
                                    <div className="flex-1 font-bold">{p.name}</div>
                                    <div className="text-indigo-600 font-black">{p.votes}</div>
                                </div>
                            ))}
                        </div>
                        <div className="lg:col-span-2 bg-white p-8 rounded-[2rem] border shadow-sm h-[400px]">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={chartData}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                    <XAxis dataKey="name" /> <YAxis /> <Tooltip />
                                    <Bar dataKey="votes" radius={[10, 10, 0, 0]}>
                                        {chartData.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                                    </Bar>
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---

        const App = () => {
            const [view, setView] = useState(AppView.ADMIN);
            const [participants, setParticipants] = useState([]);
            const [votedForId, setVotedForId] = useState(null);
            const [sessionTitle, setSessionTitle] = useState('Голосование');

            useEffect(() => {
                const saved = localStorage.getItem('live_vote_state');
                if (saved) {
                    const { participants, sessionTitle } = JSON.parse(saved);
                    setParticipants(participants || []);
                    setSessionTitle(sessionTitle || 'Голосование');
                }
                const vote = localStorage.getItem('voted_for_id');
                if (vote) setVotedForId(vote);

                const handleHash = () => {
                    const h = window.location.hash;
                    if (h === '#vote') setView(AppView.VOTE);
                    else if (h === '#results') setView(AppView.LEADERBOARD);
                    else setView(AppView.ADMIN);
                };
                handleHash();
                window.addEventListener('hashchange', handleHash);
                return () => window.removeEventListener('hashchange', handleHash);
            }, []);

            useEffect(() => {
                localStorage.setItem('live_vote_state', JSON.stringify({ participants, sessionTitle }));
            }, [participants, sessionTitle]);

            const handleVote = (id) => {
                if (votedForId) return;
                setParticipants(p => p.map(x => x.id === id ? { ...x, votes: x.votes + 1 } : x));
                setVotedForId(id);
                localStorage.setItem('voted_for_id', id);
                window.location.hash = 'results';
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <Navbar currentView={view} setView={setView} />
                    <main className="flex-grow container mx-auto px-4 py-8">
                        {view === AppView.ADMIN && <AdminView participants={participants} onAdd={(n, img) => setParticipants(p => [...p, { id: Date.now().toString(), name: n, photoUrl: img, votes: 0 }])} onDelete={id => setParticipants(p => p.filter(x => x.id !== id))} onReset={() => { if(confirm('Сбросить?')){ setParticipants([]); setVotedForId(null); localStorage.removeItem('voted_for_id'); } }} sessionTitle={sessionTitle} setSessionTitle={setSessionTitle} />}
                        {view === AppView.VOTE && <VoterView participants={participants} onVote={handleVote} hasVoted={!!votedForId} sessionTitle={sessionTitle} />}
                        {view === AppView.LEADERBOARD && <LeaderboardView participants={participants} sessionTitle={sessionTitle} />}
                    </main>
                    <footer className="py-6 text-center text-slate-400 text-xs border-t bg-white">LiveVote 2024</footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setTimeout(() => {
            const screen = document.getElementById('loading-screen');
            if (screen) { screen.style.opacity = '0'; setTimeout(() => screen.remove(), 500); }
        }, 500);
    </script>
</body>
</html>
