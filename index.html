
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LiveVote - Система живого голосования</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            margin: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        #loading-screen {
            position: fixed;
            inset: 0;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #debug-info {
            margin-top: 20px;
            font-size: 12px;
            color: #ef4444;
            max-width: 80%;
            text-align: center;
            display: none;
            font-family: monospace;
            background: #fef2f2;
            padding: 10px;
            border-radius: 8px;
        }
    </style>

    <script>
        // Глобальные переменные окружения
        window.process = { env: { API_KEY: '' } };
        
        // Перехват ошибок для вывода на экран
        window.onerror = function(msg, url, line) {
            const debug = document.getElementById('debug-info');
            if (debug) {
                debug.style.display = 'block';
                debug.innerText = "Ошибка: " + msg + "\nСтрока: " + line;
            }
        };
    </script>

    <!-- Загрузка Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/",
    "recharts": "https://esm.sh/recharts@^3.6.0",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "qrcode.react": "https://esm.sh/qrcode.react@^4.2.0"
  }
}
</script>
</head>
<body>
    <div id="loading-screen">
        <div class="spinner"></div>
        <div style="color: #64748b; font-weight: 600; font-size: 14px;">Инициализация LiveVote...</div>
        <div id="debug-info"></div>
    </div>

    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript">
        // Импортируем всё напрямую из esm.sh для максимальной совместимости
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@19.0.0';
        import ReactDOM from 'https://esm.sh/react-dom@19.0.0/client';
        import { 
            Settings, Users, BarChart3, Vote, Plus, Trash2, 
            RefreshCcw, QrCode, Loader2, Download, Copy, 
            CheckCircle2, Info, AlertTriangle, Check, Star, UserCheck, TrendingUp, Trophy
        } from 'https://esm.sh/lucide-react@0.460.0';
        import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } from 'https://esm.sh/recharts@2.13.3';
        import { QRCodeSVG } from 'https://esm.sh/qrcode.react@4.1.0';
        import { GoogleGenAI } from 'https://esm.sh/@google/genai@0.21.0';

        // --- Типы ---
        const AppView = {
            ADMIN: 'admin',
            VOTE: 'vote',
            LEADERBOARD: 'leaderboard'
        };

        // --- Компоненты ---

        const Navbar = ({ currentView, setView }) => (
            <nav className="bg-white border-b sticky top-0 z-50">
                <div className="container mx-auto px-4 h-16 flex items-center justify-between">
                    <div className="flex items-center gap-2 cursor-pointer" onClick={() => { window.location.hash = ''; setView(AppView.ADMIN); }}>
                        <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                            <Vote className="text-white w-5 h-5" />
                        </div>
                        <span className="font-bold text-xl tracking-tight text-slate-800">LiveVote</span>
                    </div>
                    <div className="hidden md:flex items-center gap-6">
                        <button onClick={() => { window.location.hash = ''; setView(AppView.ADMIN); }} className={`flex items-center gap-1.5 px-3 py-2 rounded-md transition-colors ${currentView === AppView.ADMIN ? 'bg-indigo-50 text-indigo-600' : 'text-slate-600 hover:bg-slate-50'}`}>
                            <Settings className="w-4 h-4" /> <span className="font-medium text-sm">Админ</span>
                        </button>
                        <button onClick={() => { window.location.hash = 'vote'; setView(AppView.VOTE); }} className={`flex items-center gap-1.5 px-3 py-2 rounded-md transition-colors ${currentView === AppView.VOTE ? 'bg-indigo-50 text-indigo-600' : 'text-slate-600 hover:bg-slate-50'}`}>
                            <Users className="w-4 h-4" /> <span className="font-medium text-sm">Голосование</span>
                        </button>
                        <button onClick={() => { window.location.hash = 'results'; setView(AppView.LEADERBOARD); }} className={`flex items-center gap-1.5 px-3 py-2 rounded-md transition-colors ${currentView === AppView.LEADERBOARD ? 'bg-indigo-50 text-indigo-600' : 'text-slate-600 hover:bg-slate-50'}`}>
                            <BarChart3 className="w-4 h-4" /> <span className="font-medium text-sm">Результаты</span>
                        </button>
                    </div>
                </div>
            </nav>
        );

        const AdminView = ({ participants, onAdd, onDelete, onReset, sessionTitle, setSessionTitle }) => {
            const [isProcessing, setIsProcessing] = useState(false);
            const [processedCount, setProcessedCount] = useState(0);
            const fileInputRef = useRef(null);
            const qrRef = useRef(null);
            const voteUrl = window.location.href.split('#')[0] + '#vote';

            const compressImage = (file) => new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        let width = img.width, height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });

            const handleFileChange = async (e) => {
                const files = e.target.files;
                if (!files || files.length === 0) return;
                setIsProcessing(true);
                const fileArray = Array.from(files);
                for (let i = 0; i < fileArray.length; i++) {
                    const compressed = await compressImage(fileArray[i]);
                    onAdd(`Участник #${participants.length + i + 1}`, compressed);
                    setProcessedCount(i + 1);
                }
                setIsProcessing(false);
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            const downloadQR = () => {
                const svg = qrRef.current;
                if (!svg) return;
                const svgData = new XMLSerializer().serializeToString(svg);
                const canvas = document.createElement("canvas");
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width; canvas.height = img.height;
                    canvas.getContext("2d").drawImage(img, 0, 0);
                    const link = document.createElement("a");
                    link.download = "livevote-qr.png";
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                };
                img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgData)));
            };

            return (
                <div className="max-w-6xl mx-auto space-y-8 pb-20">
                    <div className="bg-white p-8 rounded-3xl border shadow-sm flex flex-col md:flex-row justify-between gap-6">
                        <div className="flex-1">
                            <h1 className="text-3xl font-black text-slate-900 mb-2">Настройка</h1>
                            <input type="text" value={sessionTitle} onChange={(e) => setSessionTitle(e.target.value)} className="text-indigo-600 font-bold border-b border-dashed border-indigo-200 focus:border-indigo-500 outline-none w-full text-lg" />
                        </div>
                        <button onClick={onReset} className="flex items-center gap-2 px-5 py-2 text-red-600 hover:bg-red-50 rounded-xl transition-all border border-red-100 font-bold">
                            <RefreshCcw className="w-4 h-4" /> Сброс
                        </button>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div className="lg:col-span-8 space-y-6">
                            <div onClick={() => !isProcessing && fileInputRef.current?.click()} className={`p-10 rounded-[2.5rem] border-4 border-dashed transition-all flex flex-col items-center justify-center min-h-[250px] cursor-pointer ${isProcessing ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100 hover:border-indigo-400'}`}>
                                {isProcessing ? <div className="text-center"><Loader2 className="w-12 h-12 text-indigo-600 animate-spin mx-auto mb-4" /><p className="font-bold">Загрузка {processedCount}...</p></div> : <div className="text-center"><Plus className="w-12 h-12 text-indigo-400 mx-auto mb-4" /><h3 className="text-2xl font-black">Добавить фото</h3><p className="text-slate-400">Нажмите для выбора файлов</p></div>}
                                <input ref={fileInputRef} type="file" multiple accept="image/*" onChange={handleFileChange} className="hidden" />
                            </div>
                            <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                {participants.map((p, idx) => (
                                    <div key={p.id} className="relative group bg-white border rounded-2xl overflow-hidden shadow-sm">
                                        <img src={p.photoUrl} className="aspect-square w-full object-cover" />
                                        <button onClick={() => onDelete(p.id)} className="absolute top-2 right-2 p-1 bg-white/90 text-red-500 rounded-md shadow-sm"><Trash2 className="w-4 h-4" /></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="lg:col-span-4">
                            <div className="bg-slate-900 p-8 rounded-[2.5rem] text-white text-center space-y-6 sticky top-24">
                                <h3 className="text-xl font-black flex items-center justify-center gap-2"><QrCode className="w-6 h-6 text-indigo-400" /> Вход для зрителей</h3>
                                <div className="bg-white p-4 rounded-3xl inline-block shadow-2xl">
                                    <QRCodeSVG ref={qrRef} value={voteUrl} size={180} level="H" />
                                </div>
                                <button onClick={downloadQR} className="w-full py-4 bg-indigo-600 hover:bg-indigo-500 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all">
                                    <Download className="w-4 h-4" /> Скачать QR
                                </button>
                                <p className="text-[10px] text-slate-500 font-mono break-all opacity-50">{voteUrl}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const VoterView = ({ participants, onVote, hasVoted, sessionTitle }) => {
            const [selectedId, setSelectedId] = useState(null);
            if (hasVoted) return (
                <div className="max-w-md mx-auto text-center py-24 px-6 animate-in zoom-in">
                    <div className="w-20 h-20 bg-indigo-600 text-white rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-xl rotate-3"><UserCheck className="w-10 h-10" /></div>
                    <h2 className="text-4xl font-black mb-4">Принято!</h2>
                    <p className="text-slate-500 mb-8">Ваш голос успешно учтен.</p>
                    <button onClick={() => window.location.hash = 'results'} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-lg">СМОТРЕТЬ РЕЙТИНГ</button>
                </div>
            );
            return (
                <div className="max-w-4xl mx-auto px-4 pb-40">
                    <div className="text-center mb-12 mt-6"><h1 className="text-4xl font-black text-slate-900 leading-tight">{sessionTitle}</h1><p className="text-slate-500 font-medium">Выберите одного фаворита</p></div>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6">
                        {participants.map((p, idx) => (
                            <div key={p.id} onClick={() => setSelectedId(p.id)} className={`relative rounded-[2rem] overflow-hidden bg-white border-4 transition-all duration-300 shadow-md ${selectedId === p.id ? 'border-indigo-600 scale-[1.03] ring-8 ring-indigo-50' : 'border-white'}`}>
                                <img src={p.photoUrl} className="aspect-[3/4] w-full object-cover" />
                                <div className="absolute bottom-0 inset-x-0 p-4 bg-gradient-to-t from-black/80 to-transparent flex items-end justify-between text-white">
                                    <p className="text-xl font-black">#{idx + 1}</p>
                                    {selectedId === p.id && <div className="bg-indigo-600 p-1.5 rounded-xl shadow-lg"><Check className="w-5 h-5 stroke-[4px]" /></div>}
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="fixed bottom-8 left-0 right-0 px-6 z-50">
                        <button disabled={!selectedId} onClick={() => onVote(selectedId)} className={`max-w-sm mx-auto w-full py-5 rounded-[2rem] font-black text-xl shadow-2xl transition-all active:scale-95 ${selectedId ? 'bg-indigo-600 text-white translate-y-0' : 'bg-slate-200 text-slate-400 translate-y-4 opacity-50'}`}>ГОЛОСОВАТЬ</button>
                    </div>
                </div>
            );
        };

        const LeaderboardView = ({ participants, sessionTitle }) => {
            const sorted = useMemo(() => [...participants].sort((a, b) => b.votes - a.votes), [participants]);
            const totalVotes = useMemo(() => participants.reduce((acc, p) => acc + p.votes, 0), [participants]);
            const [aiInsight, setAiInsight] = useState('');

            useEffect(() => {
                if (participants.length === 0 || totalVotes === 0) return;
                const getAI = async () => {
                    try {
                        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                        const res = await ai.models.generateContent({
                            model: 'gemini-3-flash-preview',
                            contents: `Голосование "${sessionTitle}". Проголосовало ${totalVotes}. Лидер: ${sorted[0].name}. Напиши позитивную фразу (5-7 слов).`,
                        });
                        setAiInsight(res.text);
                    } catch (e) {}
                };
                getAI();
            }, [sorted[0]?.votes, totalVotes]);

            const chartData = participants.map(p => ({ name: p.name.substring(0, 8), votes: p.votes })).sort((a,b) => b.votes - a.votes);
            const COLORS = ['#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#f59e0b'];

            return (
                <div className="max-w-6xl mx-auto space-y-8 animate-in fade-in">
                    <div className="bg-white p-10 rounded-[2.5rem] border shadow-sm flex flex-col md:flex-row items-center justify-between gap-6">
                        <div><h1 className="text-4xl font-black text-slate-900 tracking-tight">{sessionTitle}</h1><p className="text-indigo-500 font-bold uppercase tracking-widest text-xs">Live Результаты</p></div>
                        <div className="bg-slate-50 px-8 py-4 rounded-3xl text-center"><p className="text-5xl font-black text-slate-900">{totalVotes}</p><p className="text-[10px] font-black text-slate-400 tracking-widest">ВСЕГО ГОЛОСОВ</p></div>
                    </div>
                    {aiInsight && <div className="bg-indigo-600 text-white p-6 rounded-[2rem] shadow-lg border-b-4 border-indigo-800"><p className="font-bold italic text-lg leading-relaxed">"{aiInsight}"</p></div>}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="bg-white p-8 rounded-[2rem] border shadow-sm space-y-6">
                            <h3 className="text-xl font-black flex items-center gap-2"><Trophy className="text-yellow-500 w-6 h-6" /> Лидерборд</h3>
                            <div className="space-y-4">
                                {sorted.slice(0, 5).map((p, i) => (
                                    <div key={p.id} className={`flex items-center gap-4 p-4 rounded-2xl border ${i === 0 ? 'bg-indigo-50 border-indigo-100' : 'bg-white border-slate-50'}`}>
                                        <div className="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center font-black text-xs">{i+1}</div>
                                        <img src={p.photoUrl} className="w-10 h-10 rounded-lg object-cover shadow-sm" />
                                        <div className="flex-1 font-bold text-slate-700 truncate">{p.name}</div>
                                        <div className="text-indigo-600 font-black text-lg">{p.votes}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="lg:col-span-2 bg-white p-8 rounded-[2rem] border shadow-sm h-[450px]">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={chartData}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                    <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fontSize: 12, fontWeight: 700}} /> 
                                    <YAxis axisLine={false} tickLine={false} hide /> 
                                    <Tooltip cursor={{fill: '#f8fafc'}} contentStyle={{borderRadius: '16px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)'}} />
                                    <Bar dataKey="votes" radius={[12, 12, 0, 0]} barSize={40}>
                                        {chartData.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                                    </Bar>
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Основное Приложение ---

        const App = () => {
            const [view, setView] = useState(AppView.ADMIN);
            const [participants, setParticipants] = useState([]);
            const [votedForId, setVotedForId] = useState(null);
            const [sessionTitle, setSessionTitle] = useState('Голосование 2024');

            useEffect(() => {
                const saved = localStorage.getItem('live_vote_state');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        setParticipants(parsed.participants || []);
                        setSessionTitle(parsed.sessionTitle || 'Голосование 2024');
                    } catch(e) {}
                }
                const vote = localStorage.getItem('voted_for_id');
                if (vote) setVotedForId(vote);

                const handleHash = () => {
                    const h = window.location.hash;
                    if (h === '#vote') setView(AppView.VOTE);
                    else if (h === '#results') setView(AppView.LEADERBOARD);
                    else setView(AppView.ADMIN);
                };
                handleHash();
                window.addEventListener('hashchange', handleHash);
                return () => window.removeEventListener('hashchange', handleHash);
            }, []);

            useEffect(() => {
                localStorage.setItem('live_vote_state', JSON.stringify({ participants, sessionTitle }));
            }, [participants, sessionTitle]);

            const handleVote = (id) => {
                if (votedForId) return;
                setParticipants(p => p.map(x => x.id === id ? { ...x, votes: (x.votes || 0) + 1 } : x));
                setVotedForId(id);
                localStorage.setItem('voted_for_id', id);
                window.location.hash = 'results';
            };

            return (
                <div className="min-h-screen flex flex-col bg-[#fcfdfe]">
                    <Navbar currentView={view} setView={setView} />
                    <main className="flex-grow container mx-auto px-4 py-8 max-w-7xl">
                        {view === AppView.ADMIN && <AdminView participants={participants} onAdd={(n, img) => setParticipants(p => [...p, { id: Date.now() + Math.random().toString(), name: n, photoUrl: img, votes: 0 }])} onDelete={id => setParticipants(p => p.filter(x => x.id !== id))} onReset={() => { if(confirm('Удалить всё?')){ setParticipants([]); setVotedForId(null); localStorage.removeItem('voted_for_id'); } }} sessionTitle={sessionTitle} setSessionTitle={setSessionTitle} />}
                        {view === AppView.VOTE && <VoterView participants={participants} onVote={handleVote} hasVoted={!!votedForId} sessionTitle={sessionTitle} />}
                        {view === AppView.LEADERBOARD && <LeaderboardView participants={participants} sessionTitle={sessionTitle} />}
                    </main>
                    <footer className="py-8 text-center text-slate-400 text-[10px] font-bold uppercase tracking-widest">LiveVote Engine • 2024</footer>
                </div>
            );
        };

        // Запуск
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
            
            // Плавное скрытие экрана загрузки
            setTimeout(() => {
                const screen = document.getElementById('loading-screen');
                if (screen) {
                    screen.style.opacity = '0';
                    setTimeout(() => screen.remove(), 500);
                }
            }, 800);
        } catch (err) {
            console.error("Render Error:", err);
            document.getElementById('debug-info').style.display = 'block';
            document.getElementById('debug-info').innerText = "Критическая ошибка: " + err.message;
        }
    </script>
</body>
</html>
