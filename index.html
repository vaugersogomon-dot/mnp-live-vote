
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LiveVote AI - Система голосования на базе Google Gemini</title>
    
    <!-- Google Fonts & Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Библиотеки Google & React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --google-blue: #4285F4;
            --google-red: #EA4335;
            --google-yellow: #FBBC05;
            --google-green: #34A853;
        }
        body {
            font-family: 'Google Sans', 'Roboto', sans-serif;
            background-color: #f7f9fc;
            color: #1f1f1f;
            margin: 0;
            overflow-x: hidden;
        }
        .material-card {
            background: white;
            border-radius: 28px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .material-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .btn-google {
            background-color: var(--google-blue);
            color: white;
            border-radius: 100px;
            padding: 12px 24px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-google:hover {
            box-shadow: 0 1px 3px rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
            background-color: #1a73e8;
        }
        #loading-screen {
            position: fixed;
            inset: 0;
            background: #f7f9fc;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .google-loader {
            display: flex;
            gap: 8px;
        }
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: bounce 0.5s infinite alternate;
        }
        .dot:nth-child(1) { background: var(--google-blue); animation-delay: 0s; }
        .dot:nth-child(2) { background: var(--google-red); animation-delay: 0.1s; }
        .dot:nth-child(3) { background: var(--google-yellow); animation-delay: 0.2s; }
        .dot:nth-child(4) { background: var(--google-green); animation-delay: 0.3s; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="google-loader mb-4">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
        <div style="color: #5f6368; font-weight: 500;">Запуск LiveVote AI...</div>
    </div>

    <div id="root"></div>

    <!-- Загрузка SDK Gemini API через ESM -->
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@0.21.0"
      }
    }
    </script>

    <script type="text/babel">
        import { GoogleGenAI } from "@google/genai";

        const { useState, useEffect, useMemo, useRef } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } = Recharts;

        // Инициализация Gemini
        const ai = new GoogleGenAI({ apiKey: window.process?.env?.API_KEY || '' });

        const AppView = { ADMIN: 'admin', VOTE: 'vote', LEADERBOARD: 'leaderboard' };

        const Icon = ({ name, className = "w-5 h-5" }) => {
            return <i data-lucide={name} className={className}></i>;
        };

        const Navbar = ({ currentView, setView }) => (
            <nav className="bg-white border-b px-6 py-3 flex items-center justify-between sticky top-0 z-50">
                <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView(AppView.ADMIN)}>
                    <div className="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center shadow-md">
                        <Icon name="vote" className="text-white w-6 h-6" />
                    </div>
                    <span className="text-xl font-medium tracking-tight text-gray-800">LiveVote <span className="text-blue-600 font-bold">AI</span></span>
                </div>
                <div className="flex bg-gray-100 p-1 rounded-full">
                    {[
                        { id: AppView.ADMIN, icon: 'settings', label: 'Админ' },
                        { id: AppView.VOTE, icon: 'users', label: 'Голоса' },
                        { id: AppView.LEADERBOARD, icon: 'bar-chart-3', label: 'Итоги' }
                    ].map(tab => (
                        <button 
                            key={tab.id}
                            onClick={() => setView(tab.id)}
                            className={`flex items-center gap-2 px-5 py-2 rounded-full text-sm font-medium transition-all ${currentView === tab.id ? 'bg-white shadow-sm text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                        >
                            <Icon name={tab.icon} className="w-4 h-4" />
                            <span className="hidden sm:inline">{tab.label}</span>
                        </button>
                    ))}
                </div>
            </nav>
        );

        const AdminView = ({ participants, onAdd, onDelete, onReset, sessionTitle, setSessionTitle, updateAIInfo }) => {
            const [isAnalyzing, setIsAnalyzing] = useState(null);
            const fileInputRef = useRef(null);
            const voteUrl = window.location.href.split('#')[0] + '#vote';

            const analyzeWithGemini = async (id, photoBase64) => {
                setIsAnalyzing(id);
                try {
                    // Извлекаем чистые данные base64
                    const base64Data = photoBase64.split(',')[1];
                    const response = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: [
                            {
                                parts: [
                                    { text: "Посмотри на это фото участника голосования. Опиши его одним коротким, вдохновляющим предложением (максимум 10 слов) для подписи в карточке. Начни сразу с текста." },
                                    { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                                ]
                            }
                        ]
                    });
                    updateAIInfo(id, response.text || "Харизматичный участник");
                } catch (error) {
                    console.error("AI Error:", error);
                    updateAIInfo(id, "Готов к победе!");
                }
                setIsAnalyzing(null);
            };

            const handleFileChange = async (e) => {
                const files = e.target.files;
                if (!files) return;
                for (let file of files) {
                    const reader = new FileReader();
                    reader.onload = (ev) => onAdd(`Участник #${participants.length + 1}`, ev.target.result);
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="max-w-5xl mx-auto py-8 px-4 space-y-8 animate-in fade-in">
                    <div className="material-card p-8 border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-6">
                        <div className="flex-1 w-full">
                            <label className="text-xs font-bold text-gray-400 uppercase tracking-widest block mb-2">Название сессии</label>
                            <input 
                                type="text" 
                                value={sessionTitle} 
                                onChange={(e) => setSessionTitle(e.target.value)} 
                                className="text-3xl font-bold bg-transparent border-b-2 border-transparent focus:border-blue-500 outline-none w-full pb-1 transition-all"
                            />
                        </div>
                        <button onClick={onReset} className="text-red-500 font-medium hover:bg-red-50 px-6 py-2 rounded-full transition-all">
                            Сбросить данные
                        </button>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 space-y-6">
                            <div 
                                onClick={() => fileInputRef.current?.click()}
                                className="material-card p-12 border-2 border-dashed border-gray-200 flex flex-col items-center justify-center cursor-pointer hover:border-blue-400 hover:bg-blue-50/30 transition-all group"
                            >
                                <div className="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 mb-4 group-hover:scale-110 transition-transform">
                                    <Icon name="plus" className="w-8 h-8" />
                                </div>
                                <h3 className="text-xl font-bold">Добавить участников</h3>
                                <p className="text-gray-500">Загрузите фотографии (до 10 МБ каждая)</p>
                                <input ref={fileInputRef} type="file" multiple accept="image/*" onChange={handleFileChange} className="hidden" />
                            </div>

                            <div className="grid grid-cols-2 md:grid-cols-3 gap-6">
                                {participants.map(p => (
                                    <div key={p.id} className="material-card overflow-hidden border border-gray-100 group">
                                        <div className="aspect-[3/4] relative">
                                            <img src={p.photoUrl} className="w-full h-full object-cover" />
                                            <button onClick={() => onDelete(p.id)} className="absolute top-2 right-2 p-2 bg-white/90 text-red-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-sm">
                                                <Icon name="trash-2" className="w-4 h-4" />
                                            </button>
                                        </div>
                                        <div className="p-4 space-y-3">
                                            <div className="text-sm font-bold text-gray-800">№ {participants.indexOf(p)+1}</div>
                                            {p.aiDescription ? (
                                                <p className="text-xs text-gray-500 italic bg-blue-50 p-2 rounded-lg leading-relaxed">
                                                    “{p.aiDescription}”
                                                </p>
                                            ) : (
                                                <button 
                                                    onClick={() => analyzeWithGemini(p.id, p.photoUrl)}
                                                    disabled={isAnalyzing === p.id}
                                                    className="w-full py-2 bg-gray-100 text-gray-600 rounded-xl text-xs font-bold hover:bg-blue-600 hover:text-white transition-all flex items-center justify-center gap-2"
                                                >
                                                    {isAnalyzing === p.id ? <Icon name="loader-2" className="animate-spin w-3 h-3" /> : <Icon name="sparkles" className="w-3 h-3" />}
                                                    Анализ ИИ
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="space-y-6">
                            <div className="material-card p-8 border border-gray-100 bg-gray-900 text-white text-center shadow-xl">
                                <h3 className="text-xl font-bold mb-6 flex items-center justify-center gap-2">
                                    <Icon name="qr-code" className="text-blue-400" /> Вход для всех
                                </h3>
                                <div className="bg-white p-4 rounded-3xl inline-block mb-6">
                                    <img src={`https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(voteUrl)}`} className="w-full" />
                                </div>
                                <div className="text-xs text-gray-400 font-mono break-all opacity-50 bg-white/5 p-4 rounded-2xl">
                                    {voteUrl}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const VoterView = ({ participants, onVote, hasVoted, sessionTitle }) => {
            const [selected, setSelected] = useState(null);
            
            if (hasVoted) return (
                <div className="max-w-md mx-auto text-center py-24 px-6">
                    <div className="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner">
                        <Icon name="check" className="w-12 h-12" />
                    </div>
                    <h2 className="text-4xl font-bold mb-4">Голос учтен!</h2>
                    <p className="text-gray-500 mb-10 text-lg">Спасибо за участие. Результаты обновляются в реальном времени.</p>
                    <button onClick={() => window.location.hash = 'results'} className="btn-google w-full text-lg">СМОТРЕТЬ ИТОГИ</button>
                </div>
            );

            return (
                <div className="max-w-4xl mx-auto px-4 pb-48 pt-10">
                    <div className="text-center mb-12">
                        <h1 className="text-4xl font-bold text-gray-900 mb-4">{sessionTitle}</h1>
                        <span className="bg-blue-100 text-blue-700 px-4 py-1 rounded-full text-xs font-bold uppercase tracking-widest">Выберите лучшего</span>
                    </div>
                    
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-6">
                        {participants.map(p => (
                            <div 
                                key={p.id} 
                                onClick={() => setSelected(p.id)}
                                className={`material-card overflow-hidden border-4 transition-all duration-300 cursor-pointer ${selected === p.id ? 'border-blue-600 scale-105 shadow-2xl' : 'border-white hover:border-gray-100'}`}
                            >
                                <img src={p.photoUrl} className="aspect-[3/4] w-full object-cover" />
                                <div className="p-4 bg-white flex items-center justify-between">
                                    <div>
                                        <p className="font-bold text-gray-900 text-lg">№ {participants.indexOf(p)+1}</p>
                                        <p className="text-[10px] text-gray-400 italic truncate max-w-[120px]">{p.aiDescription}</p>
                                    </div>
                                    {selected === p.id && <div className="bg-blue-600 p-2 rounded-full text-white"><Icon name="check" /></div>}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="fixed bottom-10 left-0 right-0 px-6 z-50 flex justify-center">
                        <button 
                            disabled={!selected}
                            onClick={() => onVote(selected)}
                            className={`max-w-md w-full py-6 rounded-full font-bold text-xl shadow-2xl transition-all ${selected ? 'bg-blue-600 text-white translate-y-0' : 'bg-gray-200 text-gray-400 translate-y-4 cursor-not-allowed'}`}
                        >
                            ПОДТВЕРДИТЬ ВЫБОР
                        </button>
                    </div>
                </div>
            );
        };

        const LeaderboardView = ({ participants, sessionTitle }) => {
            const sorted = useMemo(() => [...participants].sort((a, b) => b.votes - a.votes), [participants]);
            const total = useMemo(() => participants.reduce((acc, p) => acc + p.votes, 0), [participants]);
            const chartData = participants.map(p => ({ name: `№${participants.indexOf(p)+1}`, votes: p.votes }));

            return (
                <div className="max-w-6xl mx-auto py-10 px-4 space-y-10 animate-in fade-in">
                    <div className="material-card p-12 border border-gray-100 flex flex-col md:flex-row items-center justify-between gap-8">
                        <div>
                            <p className="text-blue-600 font-bold text-sm mb-2 uppercase tracking-widest">Итоги голосования</p>
                            <h1 className="text-5xl font-bold text-gray-900 tracking-tight">{sessionTitle}</h1>
                        </div>
                        <div className="bg-gray-900 text-white px-10 py-6 rounded-[2rem] text-center shadow-2xl">
                            <div className="text-6xl font-bold">{total}</div>
                            <div className="text-[10px] font-bold text-gray-500 uppercase tracking-widest mt-2">Голосов всего</div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-10">
                        <div className="lg:col-span-5 space-y-4">
                            <h3 className="text-2xl font-bold flex items-center gap-3 mb-6"><Icon name="trophy" className="text-yellow-500 w-8 h-8" /> Лидеры</h3>
                            {sorted.map((p, i) => (
                                <div key={p.id} className={`material-card p-5 border flex items-center gap-6 transition-all ${i === 0 ? 'border-blue-600 bg-blue-50/50 shadow-lg scale-105' : 'border-gray-100'}`}>
                                    <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl ${i === 0 ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-100 text-gray-400'}`}>{i + 1}</div>
                                    <img src={p.photoUrl} className="w-16 h-16 rounded-2xl object-cover shadow-sm" />
                                    <div className="flex-1">
                                        <p className="font-bold text-lg">Участник №{participants.indexOf(p)+1}</p>
                                        <p className="text-xs text-gray-500 truncate max-w-[150px] italic">{p.aiDescription}</p>
                                    </div>
                                    <div className="text-4xl font-bold text-blue-600">{p.votes}</div>
                                </div>
                            ))}
                        </div>
                        <div className="lg:col-span-7 material-card p-10 border border-gray-100 flex flex-col">
                            <h3 className="text-2xl font-bold mb-10">Аналитика</h3>
                            <div className="flex-grow min-h-[400px]">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={chartData}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#eee" />
                                        <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill: '#888', fontWeight: 500}} />
                                        <YAxis hide domain={[0, 'auto']} />
                                        <Tooltip cursor={{fill: 'rgba(66, 133, 244, 0.05)'}} contentStyle={{borderRadius: '20px', border: 'none', boxShadow: '0 10px 20px rgba(0,0,0,0.1)'}} />
                                        <Bar dataKey="votes" radius={[10, 10, 0, 0]} barSize={60}>
                                            {chartData.map((_, i) => <Cell key={i} fill={i === 0 ? '#4285F4' : '#E8EAED'} />)}
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState(AppView.ADMIN);
            const [participants, setParticipants] = useState([]);
            const [votedId, setVotedId] = useState(null);
            const [sessionTitle, setSessionTitle] = useState('Премия года 2024');

            useEffect(() => {
                const data = localStorage.getItem('google_vote_data');
                if (data) {
                    const parsed = JSON.parse(data);
                    setParticipants(parsed.participants || []);
                    setSessionTitle(parsed.sessionTitle || 'Премия года 2024');
                }
                const v = localStorage.getItem('voted_id_google');
                if (v) setVotedId(v);

                const hashChange = () => {
                    const h = window.location.hash;
                    if (h === '#vote') setView(AppView.VOTE);
                    else if (h === '#results') setView(AppView.LEADERBOARD);
                    else setView(AppView.ADMIN);
                };
                hashChange();
                window.addEventListener('hashchange', hashChange);
                return () => window.removeEventListener('hashchange', hashChange);
            }, []);

            useEffect(() => {
                localStorage.setItem('google_vote_data', JSON.stringify({ participants, sessionTitle }));
            }, [participants, sessionTitle]);

            const handleVote = (id) => {
                if (votedId) return;
                setParticipants(p => p.map(x => x.id === id ? { ...x, votes: x.votes + 1 } : x));
                setVotedId(id);
                localStorage.setItem('voted_id_google', id);
                window.location.hash = 'results';
            };

            const updateAIInfo = (id, text) => {
                setParticipants(p => p.map(x => x.id === id ? { ...x, aiDescription: text } : x));
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <Navbar currentView={view} setView={setView} />
                    <main className="flex-grow">
                        {view === AppView.ADMIN && (
                            <AdminView 
                                participants={participants} 
                                onAdd={(name, photo) => setParticipants(p => [...p, { id: Date.now().toString(), name, photoUrl: photo, votes: 0, aiDescription: '' }])}
                                onDelete={id => setParticipants(p => p.filter(x => x.id !== id))}
                                onReset={() => { if(confirm('Сбросить?')){ setParticipants([]); setVotedId(null); localStorage.clear(); } }}
                                sessionTitle={sessionTitle}
                                setSessionTitle={setSessionTitle}
                                updateAIInfo={updateAIInfo}
                            />
                        )}
                        {view === AppView.VOTE && <VoterView participants={participants} onVote={handleVote} hasVoted={!!votedId} sessionTitle={sessionTitle} />}
                        {view === AppView.LEADERBOARD && <LeaderboardView participants={participants} sessionTitle={sessionTitle} />}
                    </main>
                    <footer className="py-10 text-center text-gray-400 text-xs font-medium border-t bg-white">
                        Powered by Google Gemini AI & React
                    </footer>
                </div>
            );
        };

        // Рендер и инициализация иконок
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        setTimeout(() => {
            if (window.lucide) window.lucide.createIcons();
            const loader = document.getElementById('loading-screen');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 500);
            }
        }, 800);
    </script>
</body>
</html>
